\documentclass[a4paper,11pt]{article}

\usepackage[french]{babel}
\usepackage[utf8]{inputenc}
\usepackage[left=2.5cm,top=2cm,right=2.5cm,nohead,nofoot]{geometry}
\usepackage{url}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{color}
\usepackage{listings}
\DeclareMathOperator*{\join}{\bowtie}
\DeclareMathOperator*{\alpham}{\alpha}



\linespread{1.1}

\begin{document}

\section{Requ\^ete 1}
    \begin{lstlisting}
    SELECT DISTINCT subs.userID, subs.lastname, subs.firstname, subs.addresscity, stations.name FROM trips 
    INNER JOIN subs ON subs.userID = trips.userID
    INNER JOIN stations ON trips.startStation = stations.stationID
    WHERE subs.addresscity='Ixelles' and stations.name = 'FLAGEY';
    \end{lstlisting}

    \begin{gather}
    joinedTables \leftarrow trips \bowtie subs \bowtie_{startStation = stationID} \\
    filteredTables \leftarrow \sigma_{addresscity=Ixelles \bigwedge name=FLAGEY}(joinedTables)
    \end{gather}

    \begin{gather}
    {u.userID | subs(u) \wedge \exists t, trips(t) \wedge t.userID=u.userID \exists s, stations(s) \wedge t.startStation=s \wedge s.name=Flagey \wedge u.addresscity=Ixelles }
    \end{gather}

\section{Requ\^ete 2}
    \begin{lstlisting}
    SELECT DISTINCT trips2.userID
    FROM trips AS trips1
    INNER JOIN trips AS trips2 ON trips1.userID = trips2.userID AND trips1.startTime != trips2.startTime
    ORDER BY trips2.userID;

    \end{lstlisting}

    \begin{gather}
    trips1 \leftarrow \alpha_{attributes:t1.attributes}(trips)\\
    trips2 \leftarrow \alpha_{attributes:t2.attributes}(trips)\\
    joinedTables \leftarrow trips1 \bowtie_{t1.userID=t2.userID \bigwedge t1.startTime != t2.startTime} trips2\\
    result \leftarrow \pi{t2.userID}
    \end{gather}

    \begin{gather}
    {u.userID | users(u) \wedge \exists t1, t2, trips(t1), trips(t2) \wedge t1.userID = t2.userID \wedge t1 != t2}
    \end{gather}


\section{Requ\^ete 3}
    \begin{lstlisting}
    SELECT DISTINCT trip1.user, trip2.user
    FROM trips AS trip1
    INNER JOIN trips AS trip2 ON trip1.start = trip2.start AND trip1.ending = trip2.ending AND trip1.user != trip2.user;
    \end{lstlisting}

    \begin{gather}
    trips1 \leftarrow \alpha_{attributes:t1.attributes}(trips)\\
    trips2 \leftarrow \alpha_{attributes:t2.attributes}(trips)\\
    joinedTables \leftarrow trips1 \bowtie_{t1.startStation = t2.startStation
    \bigwedge t1.endingStation = t2.endingStation \bigwedge t1.userID != t2.userID } trips2 \\
    result \leftarrow \pi_{t1.user,t2.user}(joinedTables)
    \end{gather}

    \begin{gather}
    {u1.userID, u2.userID | users(u1), users(u2) \wedge \exists t1, t2, trips(t1), trips(t2) \wedge t1.userID=u1.userID \wedge t2.userID=u2.userID \wedge t1.startStation = t2.startStation \wedge t1.endingStation = t2.endingStation}
    \end{gather}


\section{Requ\^ete 4}
    \begin{lstlisting}
    SELECT DISTINCT trip1.endingStation, trip1.endingTime, trip2.startStation, trip2.startTime
    FROM trips AS trip1
    INNER JOIN trips AS trip2 ON trip1.bicycleID = trip2.bicycleID AND trip1.startTime < trip2.startTime
    GROUP BY trip2.startTime
    HAVING trip1.endingStation != trip2.startStation
    ORDER BY trip1.startTime ASC
    \end{lstlisting}
    \begin{gather}
    trips1 \leftarrow \alpha_{attributes:t1.attributes}(trips)\\
    trips2 \leftarrow \alpha_{attributes:t2.attributes}(trips)\\
    joinedTables \leftarrow trips1 \bowtie_{t1.bicycleID = t2.bicycleID \bigwedge t1.startTime < t2.startTime} trips2 \\
    filteredTables \leftarrow \sigma_{t1.endingStation != t2.startStation} (\gamma_{t2.startTime}(joinedTables))
    result \leftarrow \pi t1.endingStation, t1.endingTime, t2.startStation, t2.startTime
    \end{gather}

    \begin{gather}
    {b.bicycleID | bicycles(b) \wedge \exists t1, t2, trips(t1), trips(t2) \wedge t1.bicycleID = b.bicycleID \wedge t2.bicycleID = b.bicycleID \wedge t2.startTime > t1.startTime \wedge \nexists t3, trips(t3) \wedge t3.startTime > t1.endingTime \wedge t3.endingTime < t2.startTime \wedge t1.endingStation != t2.startStation }
    \end{gather}


\section{Requ\^ete 5}
    \begin{lstlisting}
    SELECT users.userID, subs.lastname, subs.firstname,
        (CASE WHEN subs.subscribeDate IS NOT NULL THEN subs.subscribeDate ELSE tempUsers.paymentDate END) AS subscribeDate,
        COUNT(*) AS total_trips,
        SUM(sqrt(power((s1.coordX-s2.coordX)*71, 2) + power((s1.coordY-s2.coordY)*111, 2))) AS total_distance
    FROM trips
    INNER JOIN users ON users.userID = trips.userID
    INNER JOIN stations AS s1 ON s1.stationID = trips.startStation
    INNER JOIN stations AS s2 ON s2.stationID = trips.endingStation
    LEFT OUTER JOIN subs ON subs.userID = users.userID
    LEFT OUTER JOIN tempUsers ON tempUsers.userID = users.userID
    GROUP BY trips.userID
    HAVING total_distance/total_trips
    ORDER BY COUNT(trips.userID);
    \end{lstlisting}


\section{Requ\^ete 6}
    \begin{lstlisting}
    SELECT stations.name, COUNT(trips.ending), COUNT(DISTINCT trips.user)
    FROM stations
    INNER JOIN trips ON trips.ending = stations.stationID
    GROUP BY trips.ending
    HAVING COUNT(trips.ending) >= 10;
    \end{lstlisting}


\end{document}